From 8db3c494c033acbae82aa9e614916d5551163c67 Mon Sep 17 00:00:00 2001
From: Mauro Carvalho Chehab <mchehab@redhat.com>
Date: Mon, 4 Oct 2010 12:12:38 -0300
Subject: [PATCH 2/4] libedac: allow handling up to 6 channels instead of 2

Signed-off-by: Mauro Carvalho Chehab <mchehab@redhat.com>
---
 src/lib/edac.h       |    2 +-
 src/util/edac-util.c |   79 +++++++++++++++++++-------------------------------
 2 files changed, 31 insertions(+), 50 deletions(-)

diff --git a/src/lib/edac.h b/src/lib/edac.h
index 63d378a..cb1d620 100644
--- a/src/lib/edac.h
+++ b/src/lib/edac.h
@@ -45,7 +45,7 @@
 
 #define EDAC_NAME_LEN      64
 #define EDAC_LABEL_LEN    256
-#define EDAC_MAX_CHANNELS   2
+#define EDAC_MAX_CHANNELS   6
 
 #define edac_for_each_mc_info(__h, __mc, __i) \
     for (edac_handle_reset (__h), __mc = edac_next_mc_info (__h, &__i); \
diff --git a/src/util/edac-util.c b/src/util/edac-util.c
index 1d30173..dae42b1 100644
--- a/src/util/edac-util.c
+++ b/src/util/edac-util.c
@@ -427,6 +427,7 @@ static void default_report (struct prog_ctx *ctx)
     struct edac_mc_info mci;
     struct edac_csrow_info csi;
     int count = 0;
+    int i;
 
     edac_for_each_mc_info (ctx->edac, mc, mci) {
 
@@ -441,39 +442,29 @@ static void default_report (struct prog_ctx *ctx)
         count += mci.ce_noinfo_count + mci.ue_noinfo_count;
  
         edac_for_each_csrow_info (mc, csrow, csi) {
-            char *label[2] = { "ch0", "ch1" };
-
-            if (csi.channel[0].dimm_label_valid) {
-                label[0] = csi.channel[0].dimm_label;
-            }
-            if (csi.channel[1].dimm_label_valid) {
-                label[1] = csi.channel[1].dimm_label;
-            }
 
             count += csi.ue_count;
 
             if (csi.ue_count || ctx->verbose)
                 fprintf (stdout, 
-                        "%s: %s: %s|%s: %u Uncorrected Errors\n",
-                        mci.id, csi.id, label[0], label[1], csi.ue_count);
-
-            if (!csi.channel[0].valid)
-                continue;
-
-            count += csi.channel[0].ce_count;
+                        "%s: %s: %u Uncorrected Errors\n",
+                        mci.id, csi.id, csi.ue_count);
 
-            if (csi.channel[0].ce_count || ctx->verbose)
-                fprintf (stdout, "%s: %s: %s: %u Corrected Errors\n", 
-                        mci.id, csi.id, label[0], csi.channel[0].ce_count);
+            for (i = 0; i < EDAC_MAX_CHANNELS; i++) {
+                struct edac_channel *ch = &csi.channel[i];
+                
+                if (!ch->valid)
+                    continue;
 
-            if (!csi.channel[1].valid)
-                continue;
+                if (!ch->dimm_label_valid)
+                    snprintf (ch->dimm_label, EDAC_LABEL_LEN, "ch%d", i);
 
-            count += csi.channel[1].ce_count;
+                count += ch->ce_count;
 
-            if (csi.channel[1].ce_count || ctx->verbose)
-                fprintf (stdout, "%s: %s: %s: %u Corrected Errors\n", 
-                        mci.id, csi.id, label[1], csi.channel[1].ce_count);
+                if (ch->ce_count || ctx->verbose)
+                    fprintf (stdout, "%s: %s: %s: %u Corrected Errors\n", 
+                            mci.id, csi.id, ch->dimm_label, ch->ce_count);
+            }
         }
     }
 
@@ -521,39 +512,29 @@ static void full_report (struct prog_ctx *ctx)
     edac_csrow *csrow;
     struct edac_mc_info mci;
     struct edac_csrow_info csi;
+    int i;
 
     edac_for_each_mc_info (ctx->edac, mc, mci) {
         edac_for_each_csrow_info (mc, csrow, csi) {
-            char *label[2] = { "ch0", "ch1" };
-
-            if (csi.channel[0].dimm_label_valid) {
-                label[0] = csi.channel[0].dimm_label;
-            }
-            if (csi.channel[1].dimm_label_valid) {
-                label[1] = csi.channel[1].dimm_label;
-            }
-
-            if (!ctx->quiet || csi.ue_count)
-                fprintf (stdout, "%s:%s:all:UE:%u\n", 
-                        mci.id, csi.id, csi.ue_count);
-            if (!ctx->quiet || csi.ce_count)
-                fprintf (stdout, "%s:%s:all:CE:%u\n", 
-                        mci.id, csi.id, csi.ce_count);
 
 
-            if (!csi.channel[0].valid)
-                continue;
+            for (i = 0; i < EDAC_MAX_CHANNELS; i++) {
+                struct edac_channel *ch = &csi.channel[i];
+                
+                if (!ch->valid)
+                    continue;
 
-            if (!ctx->quiet || csi.channel[0].ce_count)
-                fprintf (stdout, "%s:%s:%s:CE:%u\n", 
-                        mci.id, csi.id, label[0], csi.channel[0].ce_count);
+                if (!ch->dimm_label_valid)
+                    snprintf (ch->dimm_label, EDAC_LABEL_LEN, "ch%d", i);
 
-            if (!csi.channel[1].valid)
-                continue;
+                if (ch->ce_count || ctx->verbose)
+                    fprintf (stdout, "%s: %s: %s: %u Corrected Errors\n", 
+                            mci.id, csi.id, ch->dimm_label, ch->ce_count);
 
-            if (!ctx->quiet || csi.channel[1].ce_count)
-                fprintf (stdout, "%s:%s:%s:CE:%u\n", 
-                        mci.id, csi.id, label[1], csi.channel[1].ce_count);
+                if (!ctx->quiet || csi.channel[1].ce_count)
+                    fprintf (stdout, "%s:%s:%s:CE:%u\n", 
+                            mci.id, csi.id, ch->dimm_label,ch->ce_count);
+            }
 
         }
 
-- 
1.7.1

